# æ‰¹é‡å¤„ç†è„šæœ¬ä½¿ç”¨è¯´æ˜

## ğŸ“‹ è„šæœ¬è¯´æ˜

`migrate_existing_images.py` - æ‰¹é‡å¤„ç†ç°æœ‰å›¾ç‰‡ï¼Œç”Ÿæˆç¼©ç•¥å›¾å’Œ WebP æ ¼å¼

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é¢„è§ˆæ¨¡å¼ï¼ˆæ¨èå…ˆè¿è¡Œï¼‰

æŸ¥çœ‹å°†è¦å¤„ç†çš„å›¾ç‰‡ï¼Œä¸å®é™…æ‰§è¡Œï¼š

```bash
python scripts/migrate_existing_images.py --dry-run
```

### 2. æ­£å¼å¤„ç†

å¤„ç†æ‰€æœ‰éœ€è¦çš„å›¾ç‰‡ï¼š

```bash
python scripts/migrate_existing_images.py
```

### 3. å¼ºåˆ¶é‡æ–°å¤„ç†æ‰€æœ‰å›¾ç‰‡

```bash
python scripts/migrate_existing_images.py --force
```

---

## ğŸ“ å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--mongo-uri` | MongoDB è¿æ¥å­—ç¬¦ä¸² | `mongodb://localhost:27017/` |
| `--db-name` | æ•°æ®åº“åç§° | `your_database_name` |
| `--upload-folder` | ä¸Šä¼ æ–‡ä»¶å¤¹è·¯å¾„ | `uploads` |
| `--batch-size` | æ‰¹å¤„ç†å¤§å° | `10` |
| `--skip-existing` | è·³è¿‡å·²å¤„ç†çš„å›¾ç‰‡ | `True` |
| `--force` | å¼ºåˆ¶é‡æ–°å¤„ç†æ‰€æœ‰å›¾ç‰‡ | `False` |
| `--dry-run` | é¢„è§ˆæ¨¡å¼ï¼Œä¸å®é™…å¤„ç† | `False` |

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå¤„ç†ç‰¹å®šæ•°æ®åº“

```bash
python scripts/migrate_existing_images.py \
    --mongo-uri mongodb://localhost:27017/ \
    --db-name pic_share \
    --upload-folder /var/www/pic/uploads
```

### ç¤ºä¾‹ 2ï¼šå°æ‰¹é‡æµ‹è¯•

```bash
python scripts/migrate_existing_images.py \
    --batch-size 5 \
    --dry-run
```

### ç¤ºä¾‹ 3ï¼šå¼ºåˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰ç¼©ç•¥å›¾

```bash
python scripts/migrate_existing_images.py --force
```

---

## ğŸ“Š å¤„ç†æµç¨‹

```
1. è¿æ¥æ•°æ®åº“
   â†“
2. æŸ¥è¯¢éœ€è¦å¤„ç†çš„å›¾ç‰‡
   â†“
3. éå†æ¯å¼ å›¾ç‰‡ï¼š
   a. æ£€æŸ¥åŸå›¾æ˜¯å¦å­˜åœ¨
   b. ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
   c. ç”Ÿæˆ WebPï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
   d. æ›´æ–°æ•°æ®åº“è®°å½•
   â†“
4. æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
```

---

## ğŸ¯ å¤„ç†é€»è¾‘

### è·³è¿‡å·²å¤„ç†çš„å›¾ç‰‡

é»˜è®¤æƒ…å†µä¸‹ï¼Œè„šæœ¬ä¼šè·³è¿‡å·²ç»æœ‰ç¼©ç•¥å›¾å’Œ WebP çš„å›¾ç‰‡ï¼š

- æ£€æŸ¥ `has_thumbnail` å­—æ®µ
- æ£€æŸ¥ `has_webp` å­—æ®µ
- æ£€æŸ¥ `thumbnail_path` å’Œ `webp_path` æ˜¯å¦å­˜åœ¨

### å¼ºåˆ¶é‡æ–°å¤„ç†

ä½¿ç”¨ `--force` å‚æ•°ä¼šé‡æ–°å¤„ç†æ‰€æœ‰å›¾ç‰‡ï¼Œå³ä½¿å·²ç»æœ‰ç¼©ç•¥å›¾å’Œ WebPã€‚

---

## ğŸ“ˆ è¾“å‡ºç¤ºä¾‹

```
============================================================
å¼€å§‹æ‰¹é‡å¤„ç†å›¾ç‰‡
æ¨¡å¼: æ­£å¼å¤„ç†
æ•°æ®åº“: your_database_name
ä¸Šä¼ ç›®å½•: uploads
============================================================
æ‰¾åˆ° 1958 å¼ å›¾ç‰‡éœ€è¦å¤„ç†

å¤„ç†è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1958/1958 [15:30<00:00, 2.11it/s]

============================================================
å¤„ç†å®Œæˆï¼ç»Ÿè®¡ä¿¡æ¯ï¼š
æ€»è®¡: 1958 å¼ 
æˆåŠŸ: 1950 å¼ 
å¤±è´¥: 8 å¼ 
ç”Ÿæˆç¼©ç•¥å›¾: 1950 ä¸ª
ç”Ÿæˆ WebP: 1950 ä¸ª
============================================================
é¢„è®¡æ–°å¢å­˜å‚¨ç©ºé—´: 1015.6 MB
  - ç¼©ç•¥å›¾: 38.1 MB
  - WebP: 977.5 MB
============================================================
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¤‡ä»½æ•°æ®

**åœ¨è¿è¡Œè„šæœ¬å‰ï¼Œè¯·å…ˆå¤‡ä»½æ•°æ®åº“å’Œå›¾ç‰‡æ–‡ä»¶ï¼**

```bash
# å¤‡ä»½æ•°æ®åº“
mongodump --db your_database_name --out backup_before_migration

# å¤‡ä»½å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
tar -czf uploads_backup.tar.gz uploads/
```

### 2. ç£ç›˜ç©ºé—´

ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼š

- 1958 å¼ å›¾ç‰‡é¢„è®¡éœ€è¦çº¦ 1GB é¢å¤–ç©ºé—´
- ç¼©ç•¥å›¾ï¼šçº¦ 40MB
- WebPï¼šçº¦ 1GB

æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼š

```bash
df -h
```

### 3. å¤„ç†æ—¶é—´

- é¢„è®¡å¤„ç†æ—¶é—´ï¼š15-30 åˆ†é’Ÿï¼ˆå–å†³äºæœåŠ¡å™¨æ€§èƒ½ï¼‰
- å¹³å‡å¤„ç†é€Ÿåº¦ï¼š2-3 å¼ /ç§’

### 4. ä¸­æ–­æ¢å¤

å¦‚æœå¤„ç†è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼š

- è„šæœ¬æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- å†æ¬¡è¿è¡Œè„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡å·²å¤„ç†çš„å›¾ç‰‡
- ä½¿ç”¨ `--skip-existing` å‚æ•°ï¼ˆé»˜è®¤å¼€å¯ï¼‰

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šæ‰¾ä¸åˆ°æ¨¡å—

```
ModuleNotFoundError: No module named 'utils'
```

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œè„šæœ¬

```bash
cd /path/to/pic
python scripts/migrate_existing_images.py
```

### é—®é¢˜ 2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

```
pymongo.errors.ServerSelectionTimeoutError
```

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ MongoDB æ˜¯å¦è¿è¡Œ

```bash
sudo systemctl status mongod
sudo systemctl start mongod
```

### é—®é¢˜ 3ï¼šæƒé™é”™è¯¯

```
PermissionError: [Errno 13] Permission denied
```

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥æ–‡ä»¶å¤¹æƒé™

```bash
sudo chown -R www-data:www-data uploads/
sudo chmod -R 755 uploads/
```

### é—®é¢˜ 4ï¼šåŸå›¾ä¸å­˜åœ¨

è„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡åŸå›¾ä¸å­˜åœ¨çš„è®°å½•ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­è®°å½•ã€‚

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
tail -f logs/migration.log
```

---

## ğŸ“ æ—¥å¿—æ–‡ä»¶

æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š`logs/migration.log`

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/migration.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR logs/migration.log

# æŸ¥çœ‹å®Œæ•´æ—¥å¿—
cat logs/migration.log
```

---

## âœ… éªŒè¯å¤„ç†ç»“æœ

### 1. æ£€æŸ¥æ•°æ®åº“

```javascript
// è¿æ¥ MongoDB
mongo

// ä½¿ç”¨æ•°æ®åº“
use your_database_name

// æŸ¥è¯¢å·²å¤„ç†çš„å›¾ç‰‡æ•°é‡
db.images.count({ has_thumbnail: true, has_webp: true })

// æŸ¥è¯¢æœªå¤„ç†çš„å›¾ç‰‡
db.images.find({ 
    $or: [
        { has_thumbnail: { $ne: true } },
        { has_webp: { $ne: true } }
    ]
}).count()
```

### 2. æ£€æŸ¥æ–‡ä»¶

```bash
# æ£€æŸ¥ç¼©ç•¥å›¾æ•°é‡
ls uploads/thumbnails/ | wc -l

# æ£€æŸ¥ WebP æ•°é‡
ls uploads/webp/ | wc -l

# æ£€æŸ¥ç›®å½•å¤§å°
du -sh uploads/thumbnails/
du -sh uploads/webp/
```

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### åªå¤„ç†ç‰¹å®šæ•°é‡çš„å›¾ç‰‡ï¼ˆæµ‹è¯•ç”¨ï¼‰

ä¿®æ”¹è„šæœ¬ï¼Œåœ¨ `get_images_to_process` æ–¹æ³•ä¸­æ·»åŠ  `.limit(10)`ï¼š

```python
images = list(self.images_collection.find(query).limit(10))
```

### å¹¶å‘å¤„ç†ï¼ˆé«˜çº§ï¼‰

å¯ä»¥ä½¿ç”¨å¤šè¿›ç¨‹åŠ é€Ÿå¤„ç†ï¼Œä½†éœ€è¦æ³¨æ„æ•°æ®åº“è¿æ¥å’Œæ–‡ä»¶é”é—®é¢˜ã€‚

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- å¼€å‘è®¡åˆ’ï¼š`docs/v1.2_development_plan.md`
- éœ€æ±‚æ€»ç»“ï¼š`docs/v1.2_requirements_summary.md`
- æ›´æ–°æ—¥å¿—ï¼š`CHANGELOG.md`
