# æœåŠ¡å™¨è¿ç§»è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›äº†å®Œæ•´çš„æœåŠ¡å™¨è¿ç§»è§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©ä½ å®‰å…¨ã€å¿«é€Ÿåœ°å°†å›¾ç‰‡åˆ†äº«å¹³å°ä»æ—§æœåŠ¡å™¨è¿ç§»åˆ°æ–°æœåŠ¡å™¨ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’ŒæœåŠ¡è¿ç»­æ€§ã€‚

## ğŸ“ è¿ç§»æ–‡ä»¶è¯´æ˜

### è„šæœ¬æ–‡ä»¶

1. **`migrate.sh`** - ä¸»è¿ç§»è„šæœ¬ï¼ˆåœ¨æœ¬åœ°æœºå™¨è¿è¡Œï¼‰
   - è‡ªåŠ¨å¤‡ä»½æ—§æœåŠ¡å™¨æ•°æ®
   - ä¼ è¾“æ•°æ®åˆ°æ–°æœåŠ¡å™¨
   - æ”¯æŒæ–­ç‚¹ç»­ä¼ 

2. **`setup_new_server.sh`** - æ–°æœåŠ¡å™¨éƒ¨ç½²è„šæœ¬ï¼ˆåœ¨æ–°æœåŠ¡å™¨è¿è¡Œï¼‰
   - è‡ªåŠ¨å®‰è£…ä¾èµ–
   - æ¢å¤æ•°æ®åº“å’Œæ–‡ä»¶
   - é…ç½®å’Œå¯åŠ¨æœåŠ¡

3. **`verify_migration.sh`** - è¿ç§»éªŒè¯è„šæœ¬ï¼ˆåœ¨æ–°æœåŠ¡å™¨è¿è¡Œï¼‰
   - å…¨é¢æ£€æŸ¥æœåŠ¡çŠ¶æ€
   - éªŒè¯æ•°æ®å®Œæ•´æ€§
   - æµ‹è¯•åŠŸèƒ½å¯ç”¨æ€§

### æ–‡æ¡£æ–‡ä»¶

1. **`docs/migration_guide.md`** - è¯¦ç»†è¿ç§»æŒ‡å—
   - å®Œæ•´çš„è¿ç§»æ­¥éª¤è¯´æ˜
   - å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
   - å›æ»šæ–¹æ¡ˆ

2. **`docs/migration_quickstart.md`** - å¿«é€Ÿå¼€å§‹æŒ‡å—
   - 3æ­¥å®Œæˆè¿ç§»
   - å¿«é€Ÿå‘½ä»¤å‚è€ƒ
   - å¸¸ç”¨æ“ä½œ

3. **`docs/deployment.md`** - éƒ¨ç½²æ–‡æ¡£
   - æœåŠ¡å™¨é…ç½®è¯´æ˜
   - ç»´æŠ¤å’Œæ•…éšœæ’é™¤

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. åœ¨æœ¬åœ°æœºå™¨ä¸Šè®¾ç½®æ–°æœåŠ¡å™¨åœ°å€å¹¶è¿è¡Œè¿ç§»è„šæœ¬
export NEW_SERVER_HOST="æ–°æœåŠ¡å™¨IP"
bash migrate.sh

# 2. ç™»å½•æ–°æœåŠ¡å™¨å¹¶è¿è¡Œéƒ¨ç½²è„šæœ¬
ssh root@æ–°æœåŠ¡å™¨IP
bash setup_new_server.sh

# 3. éªŒè¯è¿ç§»ç»“æœ
bash verify_migration.sh
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨è¿ç§»

è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒ `docs/migration_quickstart.md`

## ğŸ“Š è¿ç§»æ•°æ®æ¸…å•

ä»¥ä¸‹æ•°æ®å°†è¢«è¿ç§»ï¼š

- âœ… **MongoDB æ•°æ®åº“**
  - ç”¨æˆ·ä¿¡æ¯
  - å›¾ç‰‡å…ƒæ•°æ®
  - æ ‡ç­¾å’Œåˆ†ç±»
  
- âœ… **ä¸Šä¼ æ–‡ä»¶**
  - `/var/www/pic/uploads/` ç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡

- âœ… **é…ç½®æ–‡ä»¶**
  - Nginx é…ç½®
  - Supervisor é…ç½®

- âœ… **æ—¥å¿—æ–‡ä»¶**ï¼ˆå¯é€‰ï¼‰
  - åº”ç”¨æ—¥å¿—
  - ç³»ç»Ÿæ—¥å¿—

## âš™ï¸ é…ç½®è¯´æ˜

åœ¨è¿è¡Œè„šæœ¬å‰ï¼Œè¯·ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

### migrate.sh

```bash
OLD_SERVER_HOST="120.79.186.114"  # æ—§æœåŠ¡å™¨åœ°å€
DB_NAME="your_database_name"       # æ•°æ®åº“åç§°ï¼ˆéœ€ä¿®æ”¹ï¼‰
```

### setup_new_server.sh

```bash
DB_NAME="your_database_name"       # æ•°æ®åº“åç§°ï¼ˆéœ€ä¿®æ”¹ï¼‰
DOMAIN_NAME="your_domain.com"      # åŸŸåï¼ˆéœ€ä¿®æ”¹ï¼‰
GIT_REPO="https://github.com/chf1117/pic_share.git"  # Git ä»“åº“åœ°å€
```

### verify_migration.sh

```bash
DB_NAME="your_database_name"       # æ•°æ®åº“åç§°ï¼ˆéœ€ä¿®æ”¹ï¼‰
DOMAIN_NAME="your_domain.com"      # åŸŸåï¼ˆéœ€ä¿®æ”¹ï¼‰
```

## ğŸ” éªŒè¯æ£€æŸ¥æ¸…å•

è¿ç§»å®Œæˆåï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] MongoDB æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] Nginx æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] Supervisor ç®¡ç†çš„åº”ç”¨è¿›ç¨‹è¿è¡Œæ­£å¸¸
- [ ] æ•°æ®åº“æ•°æ®å®Œæ•´ï¼ˆç”¨æˆ·æ•°ã€å›¾ç‰‡æ•°ä¸æ—§æœåŠ¡å™¨ä¸€è‡´ï¼‰
- [ ] ä¸Šä¼ æ–‡ä»¶å®Œæ•´ï¼ˆæ–‡ä»¶æ•°é‡ä¸æ—§æœåŠ¡å™¨ä¸€è‡´ï¼‰
- [ ] ç½‘ç«™å¯ä»¥é€šè¿‡ IP åœ°å€è®¿é—®
- [ ] é™æ€æ–‡ä»¶ï¼ˆCSSã€JSã€å›¾æ ‡ï¼‰å¯ä»¥æ­£å¸¸åŠ è½½
- [ ] ä¸Šä¼ çš„å›¾ç‰‡å¯ä»¥æ­£å¸¸æ˜¾ç¤º
- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æ­£å¸¸

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### æœåŠ¡ç®¡ç†

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo supervisorctl status pic
sudo systemctl status nginx
sudo systemctl status mongod

# é‡å¯æœåŠ¡
sudo supervisorctl restart pic
sudo systemctl restart nginx
sudo systemctl restart mongod

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo tail -f /var/log/supervisor/pic-stdout.log
sudo tail -f /var/log/supervisor/pic-stderr.log
```

### æ•°æ®éªŒè¯

```bash
# æ£€æŸ¥æ•°æ®åº“
mongo your_database_name --eval "db.images.count()"
mongo your_database_name --eval "db.users.count()"

# æ£€æŸ¥æ–‡ä»¶
ls -lh /var/www/pic/uploads/ | wc -l
du -sh /var/www/pic/uploads/

# æµ‹è¯•ç½‘ç«™
curl -I http://localhost
curl -I http://æœåŠ¡å™¨IP
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# åº”ç”¨æ—¥å¿—
sudo tail -50 /var/www/pic/logs/pic_app.log

# Supervisor æ—¥å¿—
sudo tail -50 /var/log/supervisor/pic-stdout.log
sudo tail -50 /var/log/supervisor/pic-stderr.log

# Nginx æ—¥å¿—
sudo tail -50 /var/log/nginx/access.log
sudo tail -50 /var/log/nginx/error.log
```

## ğŸ”„ è¿ç§»æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœ¬åœ°æœºå™¨      â”‚
â”‚  migrate.sh     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â–º 1. è¿æ¥æ—§æœåŠ¡å™¨
         â”‚   â””â”€â–º åœæ­¢æœåŠ¡
         â”‚   â””â”€â–º å¤‡ä»½æ•°æ®åº“
         â”‚   â””â”€â–º å¤‡ä»½æ–‡ä»¶
         â”‚
         â”œâ”€â–º 2. ä¼ è¾“æ•°æ®
         â”‚   â””â”€â–º å‹ç¼©å¤‡ä»½
         â”‚   â””â”€â–º ä¼ è¾“åˆ°æ–°æœåŠ¡å™¨
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–°æœåŠ¡å™¨      â”‚
â”‚ setup_new_      â”‚
â”‚ server.sh       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â–º 3. å®‰è£…ä¾èµ–
         â”‚   â””â”€â–º Python, Nginx, MongoDB
         â”‚
         â”œâ”€â–º 4. éƒ¨ç½²åº”ç”¨
         â”‚   â””â”€â–º å…‹éš†ä»£ç 
         â”‚   â””â”€â–º æ¢å¤æ•°æ®åº“
         â”‚   â””â”€â–º æ¢å¤æ–‡ä»¶
         â”‚
         â”œâ”€â–º 5. é…ç½®æœåŠ¡
         â”‚   â””â”€â–º Nginx
         â”‚   â””â”€â–º Supervisor
         â”‚
         â”œâ”€â–º 6. å¯åŠ¨æœåŠ¡
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   éªŒè¯          â”‚
â”‚ verify_         â”‚
â”‚ migration.sh    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â–º 7. æ£€æŸ¥æœåŠ¡
         â”œâ”€â–º 8. éªŒè¯æ•°æ®
         â”œâ”€â–º 9. æµ‹è¯•åŠŸèƒ½
         â”‚
         â–¼
    è¿ç§»å®Œæˆ
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½é‡è¦æ€§**
   - è¿ç§»å‰åŠ¡å¿…ç¡®è®¤å¤‡ä»½æˆåŠŸ
   - ä¿ç•™æ—§æœåŠ¡å™¨æ•°æ®è‡³å°‘ 1-2 å‘¨
   - å®šæœŸéªŒè¯å¤‡ä»½çš„å®Œæ•´æ€§

2. **åœæœºæ—¶é—´**
   - ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼Œåœæœºæ—¶é—´çº¦ 10-30 åˆ†é’Ÿ
   - å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œè¿ç§»
   - æå‰é€šçŸ¥ç”¨æˆ·

3. **DNS åˆ‡æ¢**
   - ç­‰å¾…æ–°æœåŠ¡å™¨å®Œå…¨éªŒè¯åå†åˆ‡æ¢ DNS
   - DNS ä¼ æ’­éœ€è¦æ—¶é—´ï¼ˆ5åˆ†é’Ÿåˆ°24å°æ—¶ï¼‰
   - å¯ä»¥å…ˆç”¨ IP åœ°å€æµ‹è¯•

4. **æƒé™é—®é¢˜**
   - ç¡®ä¿ www-data ç”¨æˆ·æœ‰æ­£ç¡®çš„æ–‡ä»¶æƒé™
   - æ£€æŸ¥ MongoDB çš„è®¿é—®æƒé™
   - éªŒè¯æ—¥å¿—ç›®å½•çš„å†™å…¥æƒé™

5. **ç½‘ç»œå®‰å…¨**
   - é…ç½®é˜²ç«å¢™è§„åˆ™
   - åŠæ—¶æ›´æ–° SSL è¯ä¹¦
   - å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–åŒ…

## ğŸ” å®‰å…¨å»ºè®®

1. **é…ç½® HTTPS**
   ```bash
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d your_domain.com
   ```

2. **é…ç½®é˜²ç«å¢™**
   ```bash
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw allow 22/tcp
   sudo ufw enable
   ```

3. **ä¿®æ”¹é»˜è®¤å¯†ç **
   - ä¿®æ”¹ MongoDB å¯†ç 
   - ä¿®æ”¹åº”ç”¨çš„ SECRET_KEY
   - ä¿®æ”¹æœåŠ¡å™¨ root å¯†ç 

4. **è®¾ç½®è‡ªåŠ¨å¤‡ä»½**
   ```bash
   # æ·»åŠ åˆ° crontab
   0 2 * * * mongodump --db your_database_name --out /backup/mongodb_$(date +\%Y\%m\%d)
   0 3 * * * tar -czf /backup/uploads_$(date +\%Y\%m\%d).tar.gz /var/www/pic/uploads
   ```

## ğŸ†˜ æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šMongoDB è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status mongod

# æŸ¥çœ‹æ—¥å¿—
sudo tail -50 /var/log/mongodb/mongod.log

# é‡å¯æœåŠ¡
sudo systemctl restart mongod
```

### é—®é¢˜ 2ï¼šåº”ç”¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -50 /var/log/supervisor/pic-stderr.log

# æ£€æŸ¥é…ç½®
sudo supervisorctl status pic

# æ‰‹åŠ¨æµ‹è¯•
cd /var/www/pic
source venv/bin/activate
python app.py
```

### é—®é¢˜ 3ï¼šNginx 502 é”™è¯¯

```bash
# æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
sudo supervisorctl status pic

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8000

# æµ‹è¯• Nginx é…ç½®
sudo nginx -t
```

### é—®é¢˜ 4ï¼šå›¾ç‰‡æ— æ³•æ˜¾ç¤º

```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh /var/www/pic/uploads/

# æ£€æŸ¥æƒé™
sudo chmod -R 755 /var/www/pic/uploads
sudo chown -R www-data:www-data /var/www/pic/uploads

# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t
sudo systemctl restart nginx
```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
   - `docs/migration_guide.md` - å®Œæ•´è¿ç§»æŒ‡å—
   - `docs/deployment.md` - éƒ¨ç½²æ–‡æ¡£

2. è¿è¡ŒéªŒè¯è„šæœ¬
   ```bash
   bash verify_migration.sh
   ```

3. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
   - åº”ç”¨æ—¥å¿—ï¼š`/var/www/pic/logs/pic_app.log`
   - Supervisor æ—¥å¿—ï¼š`/var/log/supervisor/pic-stderr.log`
   - Nginx æ—¥å¿—ï¼š`/var/log/nginx/error.log`

4. ä½¿ç”¨å›æ»šæ–¹æ¡ˆ
   - å‚è€ƒ `docs/migration_guide.md` ä¸­çš„å›æ»šæ­¥éª¤

## ğŸ“ è¿ç§»åä¼˜åŒ–

1. **æ€§èƒ½ä¼˜åŒ–**
   - é…ç½® MongoDB ç´¢å¼•
   - å¯ç”¨ Gzip å‹ç¼©
   - é…ç½®æµè§ˆå™¨ç¼“å­˜

2. **ç›‘æ§é…ç½®**
   - è®¾ç½®æœåŠ¡ç›‘æ§
   - é…ç½®æ—¥å¿—è½®è½¬
   - è®¾ç½®ç£ç›˜ç©ºé—´å‘Šè­¦

3. **å¤‡ä»½ç­–ç•¥**
   - æ¯æ—¥è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
   - æ¯å‘¨å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
   - å®šæœŸæµ‹è¯•æ¢å¤æµç¨‹

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼
