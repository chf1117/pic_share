# 更新日志

## [v1.19] - 2025-11-11

### 📋 版本说明
这是 v1.2 缩略图功能开发前的稳定版本备份。

### ✅ 当前功能
- 图片上传和管理
- 用户系统（登录、注册）
- 标签系统
- 点赞功能
- 年份筛选
- 懒加载和浏览器缓存
- 响应式设计

### 📝 已完成的文档
- v1.2 开发计划（`docs/v1.2_development_plan.md`）
- v1.2 设计决策（`docs/v1.2_design_decisions.md`）
- v1.2 需求总结（`docs/v1.2_requirements_summary.md`）
- 迁移指南（`Windows迁移指南.md`）
- 快速迁移手册（`docs/快速迁移手册.md`）

### 🎯 下一步计划
准备实现 v1.2 版本功能：
1. 缩略图系统（保持宽高比，不裁剪）
2. WebP 格式支持
3. 上传进度条优化
4. 失败重试机制
5. 批量处理脚本

### 📊 技术栈

## [v1.3.0] - 2025-12-01

### 📋 版本说明
本版本主要聚焦于提升用户的社交互动体验。通过实现**点赞全链路同步**和**多平台社交分享**，解决了之前版本中交互状态不一致的问题，并大大增强了图片的传播能力。

### ✅ 主要改动
- **点赞系统重构**:
  - **双向同步**: 彻底打通了列表页卡片与预览模态框之间的状态同步。无论是在浏览大图时点赞，还是在列表页快速点赞，界面上的红心状态和计数都会实时更新。
  - **逻辑修复**: 修复了在预览模式下切换图片（上一张/下一张）后，点赞对象 ID 未跟随更新的 BUG。现在切换图片会自动复用更新逻辑，确保对正确的图片进行操作。
  - **UI 优化**: 预览模态框中的点赞按钮现在会显示具体的点赞数值，并拥有了更醒目的激活状态样式。

- **社交分享模块**:
  - **微信集成**: 引入 `qrcode.js` 库，为每张图片实时生成专属二维码，解决了 PC 端无法方便分享到微信朋友圈的痛点。
  - **微博直达**: 新增微博分享按钮，点击即可跳转至微博发布页，自动填充图片链接和分享文案。
  - **快捷复制**: 实现了点击一键复制图片直链的功能，并增加了“已复制”的视觉反馈动画。
  - **移动端优化**: 针对触屏设备优化了分享模态框的布局和点击区域，确保移动端操作流畅。

### 🧪 验证要点
- 打开任意图片预览，点击心形按钮，关闭预览后，列表页对应的图片卡片应同步变为已点赞状态（红心+计数+1）。
- 在预览模式下左右切换图片，再次点赞，确认点赞的是当前显示的图片，而非第一张打开的图片。
- 点击分享按钮，选择微信，应能看到动态生成的二维码；选择复制链接，应提示“已复制”并能成功粘贴 URL。

## [v1.21] - 2025-11-22

### 📋 版本说明
在 v1.19 的基础上完成并上线了缩略图 + WebP 系统，以及与之配套的前后端优化和批量迁移。本版本对应 README 中的“当前版本 v1.21”。

### ✅ 主要改动
- 启用缩略图与 WebP 系统：上传图片时自动生成 WebP 缩略图和完整 WebP，大图与缩略图均保持原始宽高比，**原始图片路径保持不变**，兼容现有约 2000 张历史图片。
- 缩略图规格升级：将缩略图最长边从 **200px 提升到 600px**，WebP 质量提升到 **95**，在 PC 端多列布局和移动端单列浏览下都能获得明显更好的清晰度，同时保持较好的加载速度与带宽占用。
- 前端展示优化：`templates/index.html` 中的图片卡片统一使用后端返回的 `thumbnail_url` / `webp_url` 字段，通过 `<picture>` 标签优先加载 WebP，失败时回退到原始 JPEG，标签搜索结果页与普通列表页使用同一套逻辑。
- 路径规范修复：新增 `build_image_url` 辅助函数，统一将数据库中可能包含绝对路径（如 `/var/www/pic/uploads/...`）、相对路径或 Windows 风格路径转换为标准的 `/uploads/...` URL，修复了标签搜索场景下出现 `http://var/www/pic/...` 导致缩略图无法加载的问题。
- 预览模态框修复：修正图片预览在第一次打开后再次点击不弹出的 BUG，改为复用单一 Bootstrap Modal 实例并直接更新 `#previewImage.src`，保证连续预览时始终正常弹出。
- 批量迁移增强：`scripts/migrate_existing_images.py` 增加 `--force` 参数，支持在已存在缩略图/WebP 的情况下强制重新生成。本次已在服务器上使用 `--force` 对全部约 1978 张历史图片重新生成 600/95 规格的缩略图和对应 WebP，并回写数据库文件大小信息。
- 上传体验完善：`templates/upload.html` 已实现详细的单文件进度条、总体进度显示及失败重试机制，单个文件失败不会影响其他文件上传，整体行为与 v1.2 上传体验设计文档保持一致。

### 🧪 验证要点
- 首页与标签搜索页均能看到清晰的 WebP 缩略图，Network 面板中的图片请求以 `/uploads/thumbnails/*.webp` 为主。
- 点击任意图片后预览模态框可以多次正常弹出和切换图片，不再出现“第一次之后不显示”的问题。
- 历史图片与新上传图片在缩略图清晰度上的观感基本一致，说明批量迁移已覆盖历史数据。
- **后端**: Flask + PyMongo
- **数据库**: MongoDB 7.0
- **前端**: Bootstrap 5 + Vanilla JS
- **服务器**: Nginx + Supervisor
- **图片处理**: Pillow

### 🔧 部署信息
- **服务器**: 阿里云 Ubuntu 22.04
- **Python**: 3.10+
- **MongoDB**: 7.0
- **图片数量**: ~2000 张
- **存储空间**: ~1.5GB

### ⚠️ 重要提示
如果 v1.2 开发过程中出现问题，可以回退到此版本：

```bash
# 回退到 v1.19
git checkout v1.19

# 或者创建新分支
git checkout -b v1.19-stable v1.19
```

---

## [v1.2] - 开发中

### 🚀 计划功能
- [ ] 缩略图系统（最长边 200px，保持宽高比）
- [ ] WebP 格式支持（完整图 + 缩略图）
- [ ] 上传进度条显示（分阶段）
- [ ] 失败重试机制（自动重试 3 次）
- [ ] 批量处理脚本（处理现有 2000 张图片）
- [ ] 前端使用 `<picture>` 标签
- [ ] 浏览器兼容性优化

### 📝 设计原则
1. **原图路径不变**（兼容现有 2000 张图片）
2. **不裁剪图片内容**（保持摄影作品完整性）
3. **错误不影响上传**（缩略图失败仍保存原图）
4. **向后兼容**（旧数据自动回退到原图）

### 🎯 预期效果
- 首页加载速度：5-8 秒 → 0.5-1 秒（提升 8-10 倍）
- 移动端加载：8-12 秒 → 1-2 秒（提升 6-8 倍）
- 流量节省：30-35%
- 存储增加：~1GB（缩略图 40MB + WebP 1GB）

---

## 版本历史

### [v1.18] - 2024-XX-XX
- 实现懒加载和浏览器缓存策略

### [v1.17] - 2024-XX-XX
- 更新 requirements.txt 匹配服务器版本

### [v1.16] - 2024-XX-XX
- 更新部署配置和文档

---

## Git 操作指南

### 查看所有版本
```bash
git tag -l
```

### 查看版本详情
```bash
git show v1.19
```

### 回退到指定版本
```bash
# 临时查看
git checkout v1.19

# 创建新分支
git checkout -b v1.19-stable v1.19

# 强制回退（慎用）
git reset --hard v1.19
```

### 比较版本差异
```bash
# 比较两个版本
git diff v1.19 v1.2

# 查看文件变更
git diff v1.19 v1.2 --name-only
```

### 推送标签到远程
```bash
# 推送单个标签
git push origin v1.19

# 推送所有标签
git push origin --tags
```

---

## 备份建议

### 1. 代码备份
```bash
# 已完成：Git 标签 v1.19
git tag v1.19
```

### 2. 数据库备份（建议在实施 v1.2 前执行）
```bash
# 备份数据库
mongodump --db your_database_name --out backup_v1.19

# 压缩备份
tar -czf backup_v1.19_$(date +%Y%m%d).tar.gz backup_v1.19/
```

### 3. 图片备份（可选）
```bash
# 备份 uploads 目录
tar -czf uploads_backup_v1.19_$(date +%Y%m%d).tar.gz uploads/
```

---

## 联系方式

如有问题，请查看：
- 开发计划：`docs/v1.2_development_plan.md`
- 需求总结：`docs/v1.2_requirements_summary.md`
- 设计决策：`docs/v1.2_design_decisions.md`
