# å¿«é€Ÿè¿ç§»æ‰‹å†Œï¼ˆWindows â†’ é˜¿é‡Œäº‘ï¼‰

## ðŸŽ¯ ä¸€å¥è¯æ€»ç»“

åœ¨ Windows PowerShell ä¸­ SSH ç™»å½•æœåŠ¡å™¨ï¼Œå¤åˆ¶ç²˜è´´å‘½ä»¤å³å¯å®Œæˆè¿ç§»ã€‚

## âš¡ ä¸‰æ­¥å®Œæˆè¿ç§»

### ç¬¬ 1 æ­¥ï¼šå¤‡ä»½æ—§æœåŠ¡å™¨ï¼ˆ5-10åˆ†é’Ÿï¼‰

**Windows PowerShellï¼š**
```powershell
ssh root@120.79.186.114
```

**å¤åˆ¶ä»¥ä¸‹å‘½ä»¤åˆ°æœåŠ¡å™¨æ‰§è¡Œï¼š**
```bash
# ä¿®æ”¹è¿™é‡Œï¼šä½ çš„æ•°æ®åº“å
DB_NAME="your_database_name"

# ä»¥ä¸‹å‘½ä»¤ç›´æŽ¥å¤åˆ¶æ‰§è¡Œ
BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
sudo supervisorctl stop pic
mkdir -p /root/pic_backup_$BACKUP_TIME
mongodump --db $DB_NAME --out /root/pic_backup_$BACKUP_TIME/mongodb_backup
tar -czf /root/pic_backup_$BACKUP_TIME/uploads.tar.gz /var/www/pic/uploads/
cd /root && tar -czf pic_backup_$BACKUP_TIME.tar.gz pic_backup_$BACKUP_TIME/
ls -lh pic_backup_$BACKUP_TIME.tar.gz
```

### ç¬¬ 2 æ­¥ï¼šä¼ è¾“åˆ°æ–°æœåŠ¡å™¨ï¼ˆ10-30åˆ†é’Ÿï¼‰

**åœ¨æ—§æœåŠ¡å™¨ä¸Šç»§ç»­æ‰§è¡Œï¼š**
```bash
# ä¿®æ”¹è¿™é‡Œï¼šæ–°æœåŠ¡å™¨IP
NEW_SERVER_IP="æ–°æœåŠ¡å™¨IP"

# ä¼ è¾“æ•°æ®
scp pic_backup_*.tar.gz root@$NEW_SERVER_IP:/root/
exit
```

### ç¬¬ 3 æ­¥ï¼šéƒ¨ç½²æ–°æœåŠ¡å™¨ï¼ˆ10-15åˆ†é’Ÿï¼‰

**Windows PowerShellï¼ˆæ–°çª—å£ï¼‰ï¼š**
```powershell
ssh root@æ–°æœåŠ¡å™¨IP
```

**å¤åˆ¶ä»¥ä¸‹å‘½ä»¤åˆ°æ–°æœåŠ¡å™¨æ‰§è¡Œï¼š**
```bash
# ä¿®æ”¹è¿™ä¸‰ä¸ªé…ç½®
DB_NAME="your_database_name"
DOMAIN_NAME="your_domain.com"
GIT_REPO="https://github.com/chf1117/pic_share.git"

# ä»¥ä¸‹å‘½ä»¤ç›´æŽ¥å¤åˆ¶æ‰§è¡Œ
sudo apt update && sudo apt install -y python3-pip python3-venv nginx supervisor git mongodb python3-dev build-essential
sudo systemctl start mongod && sudo systemctl enable mongod
cd /root && tar -xzf pic_backup_*.tar.gz
BACKUP_DIR=$(ls -td pic_backup_* | grep -v ".tar.gz" | head -1)
sudo mkdir -p /var/www/pic && sudo chown -R $USER:$USER /var/www/pic
git clone $GIT_REPO /var/www/pic
cd /var/www/pic && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt && deactivate
mongorestore --db $DB_NAME /root/$BACKUP_DIR/mongodb_backup/$DB_NAME/
tar -xzf /root/$BACKUP_DIR/uploads.tar.gz -C /var/www/pic/
sudo mkdir -p /var/www/pic/logs /var/log/supervisor

# é…ç½® Supervisor
sudo tee /etc/supervisor/conf.d/pic.conf > /dev/null << 'EOF'
[program:pic]
directory=/var/www/pic
command=/var/www/pic/venv/bin/gunicorn -w 4 -b 127.0.0.1:8000 app:app
user=www-data
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/pic-stderr.log
stdout_logfile=/var/log/supervisor/pic-stdout.log
environment=PYTHONPATH="/var/www/pic",MONGO_URI="mongodb://localhost:27017/DB_NAME_PLACEHOLDER"
startsecs=5
stopwaitsecs=5
EOF
sudo sed -i "s/DB_NAME_PLACEHOLDER/$DB_NAME/g" /etc/supervisor/conf.d/pic.conf

# é…ç½® Nginx
sudo tee /etc/nginx/sites-available/pic > /dev/null << 'EOF'
server {
    listen 80;
    server_name DOMAIN_PLACEHOLDER;
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 10M;
    }
    location /static { alias /var/www/pic/static; }
    location /uploads { alias /var/www/pic/uploads; expires 14d; }
}
EOF
sudo sed -i "s/DOMAIN_PLACEHOLDER/$DOMAIN_NAME/g" /etc/nginx/sites-available/pic

# è®¾ç½®æƒé™å¹¶å¯åŠ¨
sudo chown -R www-data:www-data /var/www/pic/logs /var/www/pic/uploads
sudo chmod -R 755 /var/www/pic/logs /var/www/pic/uploads
sudo ln -sf /etc/nginx/sites-available/pic /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl restart nginx
sudo supervisorctl reread && sudo supervisorctl update && sudo supervisorctl start pic
sleep 3
sudo supervisorctl status pic
```

## âœ… éªŒè¯ï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# æ£€æŸ¥æœåŠ¡
sudo supervisorctl status pic
curl -I http://localhost

# æ£€æŸ¥æ•°æ®
mongo your_database_name --quiet --eval "db.images.count()"
ls /var/www/pic/uploads/ | wc -l
```

## ðŸŒ åˆ‡æ¢ DNS

1. æµè§ˆå™¨è®¿é—® `http://æ–°æœåŠ¡å™¨IP` æµ‹è¯•
2. ç™»å½•é˜¿é‡Œäº‘æŽ§åˆ¶å° â†’ äº‘è§£æž DNS
3. ä¿®æ”¹ A è®°å½•æŒ‡å‘æ–°æœåŠ¡å™¨ IP
4. ç­‰å¾… 5-30 åˆ†é’Ÿç”Ÿæ•ˆ

## ðŸ”§ å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/supervisor/pic-stdout.log

# é‡å¯æœåŠ¡
sudo supervisorctl restart pic

# æŸ¥çœ‹é”™è¯¯
sudo tail -50 /var/log/supervisor/pic-stderr.log
```

## ðŸ“ž é‡åˆ°é—®é¢˜ï¼Ÿ

æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š`Windowsè¿ç§»æŒ‡å—.md`

---

**æç¤º**ï¼šè®°å¾—ä¿®æ”¹å‘½ä»¤ä¸­çš„ä¸‰ä¸ªé…ç½®é¡¹ï¼š
1. `DB_NAME` - æ•°æ®åº“å
2. `NEW_SERVER_IP` - æ–°æœåŠ¡å™¨IP
3. `DOMAIN_NAME` - åŸŸå
