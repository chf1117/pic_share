# æœåŠ¡å™¨è¿ç§»æ­¥éª¤æ€»ç»“ï¼ˆWindows å¼€å‘çŽ¯å¢ƒ â†’ é˜¿é‡Œäº‘ Ubuntuï¼‰

## ðŸŽ¯ ç›®æ ‡

å°†å›¾ç‰‡åˆ†äº«å¹³å°ä»Žæ—§é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼ˆ120.79.186.114ï¼‰è¿ç§»åˆ°æ–°é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼Œç¡®ä¿æ•°æ®å®Œæ•´ã€æœåŠ¡æ­£å¸¸ã€‚

**å¼€å‘çŽ¯å¢ƒ**ï¼šWindows æœ¬åœ°å¼€å‘
**éƒ¨ç½²çŽ¯å¢ƒ**ï¼šé˜¿é‡Œäº‘ Ubuntu æœåŠ¡å™¨

## ðŸ“¦ éœ€è¦è¿ç§»çš„å†…å®¹

1. **MongoDB æ•°æ®åº“** - æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€å›¾ç‰‡ä¿¡æ¯ã€æ ‡ç­¾ç­‰
2. **ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶** - `/var/www/pic/uploads/` ç›®å½•
3. **åº”ç”¨ä»£ç ** - ä»Ž Git ä»“åº“é‡æ–°éƒ¨ç½²
4. **é…ç½®æ–‡ä»¶** - Nginx å’Œ Supervisor é…ç½®

## âš¡ æŽ¨èè¿ç§»æ–¹æ³•ï¼ˆç›´æŽ¥åœ¨æœåŠ¡å™¨ä¸Šæ“ä½œï¼‰

ç”±äºŽä½ åœ¨ Windows ä¸‹å¼€å‘ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ç›´æŽ¥åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šæ“ä½œï¼Œä¸éœ€è¦åœ¨ Windows ä¸Šè¿è¡Œ bash è„šæœ¬ã€‚

### å‡†å¤‡å·¥ä½œ

1. **ç¡®è®¤æ–°æœåŠ¡å™¨ä¿¡æ¯**
   - æ–°é˜¿é‡Œäº‘æœåŠ¡å™¨ IP åœ°å€
   - SSH ç™»å½•ç”¨æˆ·åï¼ˆé€šå¸¸æ˜¯ rootï¼‰
   - ç¡®ä¿æ–°æ—§æœåŠ¡å™¨éƒ½å¯ä»¥ SSH ç™»å½•

2. **ç¡®è®¤æ•°æ®åº“åç§°**ï¼ˆé‡è¦ï¼ï¼‰
   
   åœ¨ Windows PowerShell ä¸­è¿è¡Œï¼š
   ```powershell
   # SSH ç™»å½•æ—§æœåŠ¡å™¨æŸ¥çœ‹æ•°æ®åº“å
   ssh root@120.79.186.114
   ```
   
   ç„¶åŽåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š
   ```bash
   mongo
   show dbs
   # è®°ä¸‹ä½ çš„æ•°æ®åº“åç§°ï¼Œä¾‹å¦‚ï¼špic_share æˆ– your_database_name
   exit
   ```

### æ‰§è¡Œæ­¥éª¤ï¼ˆæŽ¨èæ–¹æ³•ï¼‰

**åœ¨ Windows PowerShell ä¸­è¿è¡Œï¼š**

```powershell
# SSH ç™»å½•æ—§æœåŠ¡å™¨
ssh root@120.79.186.114
```

**åœ¨æ—§æœåŠ¡å™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š**

```bash
# 1. åœæ­¢æœåŠ¡ï¼ˆç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼‰
sudo supervisorctl stop pic

# 2. åˆ›å»ºå¤‡ä»½ç›®å½•
BACKUP_TIME=$(date +%Y%m%d_%H%M%S)
mkdir -p /root/pic_backup_$BACKUP_TIME
cd /root/pic_backup_$BACKUP_TIME

# 3. å¤‡ä»½ MongoDB æ•°æ®åº“ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®žé™…æ•°æ®åº“åï¼‰
mongodump --db your_database_name --out mongodb_backup

# 4. å¤‡ä»½ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶
cd /var/www/pic
tar -czf /root/pic_backup_$BACKUP_TIME/uploads.tar.gz uploads/

# 5. å¤‡ä»½é…ç½®æ–‡ä»¶
sudo cp /etc/nginx/sites-available/pic /root/pic_backup_$BACKUP_TIME/nginx_pic.conf
sudo cp /etc/supervisor/conf.d/pic.conf /root/pic_backup_$BACKUP_TIME/supervisor_pic.conf

# 6. åˆ›å»ºè¿ç§»æ¸…å•
cat > /root/pic_backup_$BACKUP_TIME/manifest.txt << EOF
å¤‡ä»½æ—¶é—´: $(date)
æ•°æ®åº“å: your_database_name
å›¾ç‰‡æ•°é‡: $(find /var/www/pic/uploads -type f | wc -l)
æ•°æ®å¤§å°: $(du -sh /var/www/pic/uploads | cut -f1)
EOF

# 7. åŽ‹ç¼©æ‰€æœ‰å¤‡ä»½
cd /root
tar -czf pic_backup_$BACKUP_TIME.tar.gz pic_backup_$BACKUP_TIME/

# 8. æ˜¾ç¤ºå¤‡ä»½ä¿¡æ¯
echo "å¤‡ä»½å®Œæˆï¼"
ls -lh pic_backup_$BACKUP_TIME.tar.gz
cat pic_backup_$BACKUP_TIME/manifest.txt
```

#### ç¬¬äºŒæ­¥ï¼šä¼ è¾“æ•°æ®åˆ°æ–°æœåŠ¡å™¨

**åœ¨æ—§æœåŠ¡å™¨ä¸Šç»§ç»­è¿è¡Œï¼š**

```bash
# æ›¿æ¢ä¸ºä½ çš„æ–°æœåŠ¡å™¨ IP
NEW_SERVER_IP="æ–°æœåŠ¡å™¨IP"

# ä¼ è¾“å¤‡ä»½æ–‡ä»¶åˆ°æ–°æœåŠ¡å™¨
scp pic_backup_*.tar.gz root@$NEW_SERVER_IP:/root/

# ä¼ è¾“å®ŒæˆåŽï¼Œå¯ä»¥é‡å¯æ—§æœåŠ¡å™¨çš„æœåŠ¡ï¼ˆå¯é€‰ï¼‰
# sudo supervisorctl start pic
```

#### ç¬¬ä¸‰æ­¥ï¼šåœ¨æ–°æœåŠ¡å™¨ä¸Šéƒ¨ç½²

**åœ¨ Windows PowerShell ä¸­æ‰“å¼€æ–°çš„çª—å£ï¼š**

```powershell
# SSH ç™»å½•æ–°æœåŠ¡å™¨
ssh root@æ–°æœåŠ¡å™¨IP
```

**åœ¨æ–°æœåŠ¡å™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š**

#### åœ¨æ—§æœåŠ¡å™¨ä¸Šï¼ˆ120.79.186.114ï¼‰

```bash
# 1. åœæ­¢æœåŠ¡
sudo supervisorctl stop pic

# 2. å¤‡ä»½æ•°æ®åº“
cd /root
mongodump --db your_database_name --out mongodb_backup

# 3. å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
cd /var/www/pic
tar -czf /root/uploads.tar.gz uploads/

# 4. åŽ‹ç¼©æ‰€æœ‰å¤‡ä»½
cd /root
tar -czf pic_migration.tar.gz mongodb_backup/ uploads.tar.gz

# 5. ä¼ è¾“åˆ°æ–°æœåŠ¡å™¨
scp pic_migration.tar.gz root@æ–°æœåŠ¡å™¨IP:/root/
```

#### åœ¨æ–°æœåŠ¡å™¨ä¸Š

```bash
# 1. å®‰è£…å¿…è¦è½¯ä»¶
sudo apt update
sudo apt install -y python3-pip python3-venv nginx supervisor git mongodb python3-dev build-essential

# 2. å¯åŠ¨ MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod

# 3. å…‹éš†ä»£ç 
sudo mkdir -p /var/www/pic
sudo chown -R $USER:$USER /var/www/pic
git clone https://github.com/chf1117/pic_share.git /var/www/pic

# 4. åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒ
cd /var/www/pic
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
deactivate

# 5. è§£åŽ‹å¹¶æ¢å¤æ•°æ®
cd /root
tar -xzf pic_migration.tar.gz
mongorestore --db your_database_name mongodb_backup/your_database_name/
cd /var/www/pic
tar -xzf /root/uploads.tar.gz

# 6. åˆ›å»ºç›®å½•
sudo mkdir -p /var/www/pic/logs
sudo mkdir -p /var/log/supervisor

# 7. é…ç½® Supervisor
sudo nano /etc/supervisor/conf.d/pic.conf
```

å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼ˆä¿®æ”¹æ•°æ®åº“åï¼‰ï¼š
```ini
[program:pic] 
directory=/var/www/pic 
command=/var/www/pic/venv/bin/gunicorn -w 4 -b 127.0.0.1:8000 app:app 
user=www-data 
autostart=true 
autorestart=true 
stderr_logfile=/var/log/supervisor/pic-stderr.log 
stdout_logfile=/var/log/supervisor/pic-stdout.log 
environment=PYTHONPATH="/var/www/pic",MONGO_URI="mongodb://localhost:27017/your_database_name" 
startsecs=5
stopwaitsecs=5
```

```bash
# 8. é…ç½® Nginx
sudo nano /etc/nginx/sites-available/pic
```

å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼ˆä¿®æ”¹åŸŸåï¼‰ï¼š
```nginx
server {
    listen 80;
    server_name your_domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        client_max_body_size 10M;
    }

    location /static {
        alias /var/www/pic/static;
    }

    location /uploads {
        alias /var/www/pic/uploads;
        expires 14d;
        add_header Cache-Control "public, no-transform";
    }
}
```

```bash
# 9. è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/pic/logs
sudo chown -R www-data:www-data /var/www/pic/uploads
sudo chmod -R 755 /var/www/pic/logs
sudo chmod -R 755 /var/www/pic/uploads

# 10. å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo ln -s /etc/nginx/sites-available/pic /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start pic

# 11. æ£€æŸ¥çŠ¶æ€
sudo supervisorctl status pic
curl -I http://localhost
```

## âœ… éªŒè¯æ¸…å•

å®Œæˆè¿ç§»åŽï¼Œè¯·é€é¡¹æ£€æŸ¥ï¼š

```bash
# 1. æœåŠ¡çŠ¶æ€
sudo supervisorctl status pic          # åº”è¯¥æ˜¾ç¤º RUNNING
sudo systemctl status nginx            # åº”è¯¥æ˜¾ç¤º active (running)
sudo systemctl status mongod           # åº”è¯¥æ˜¾ç¤º active (running)

# 2. æ•°æ®å®Œæ•´æ€§
mongo your_database_name --eval "db.images.count()"  # æ£€æŸ¥å›¾ç‰‡æ•°é‡
mongo your_database_name --eval "db.users.count()"   # æ£€æŸ¥ç”¨æˆ·æ•°é‡
ls /var/www/pic/uploads/ | wc -l                     # æ£€æŸ¥æ–‡ä»¶æ•°é‡

# 3. ç½‘ç«™è®¿é—®
curl -I http://localhost                              # åº”è¯¥è¿”å›ž 200 æˆ– 302
curl -I http://æ–°æœåŠ¡å™¨IP                             # åº”è¯¥è¿”å›ž 200 æˆ– 302

# 4. åŠŸèƒ½æµ‹è¯•
# åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://æ–°æœåŠ¡å™¨IP
# - æµ‹è¯•ç™»å½•åŠŸèƒ½
# - æµ‹è¯•å›¾ç‰‡æ˜¾ç¤º
# - æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
```

## ðŸ”„ DNS åˆ‡æ¢

**é‡è¦ï¼šåªæœ‰åœ¨æ–°æœåŠ¡å™¨å®Œå…¨æ­£å¸¸åŽæ‰è¿›è¡Œ DNS åˆ‡æ¢ï¼**

1. ç™»å½•åŸŸåæœåŠ¡å•†æŽ§åˆ¶å°
2. æ‰¾åˆ° DNS ç®¡ç†æˆ–åŸŸåè§£æž
3. ä¿®æ”¹ A è®°å½•ï¼š
   - ä¸»æœºè®°å½•ï¼š@ æˆ– www
   - è®°å½•ç±»åž‹ï¼šA
   - è®°å½•å€¼ï¼šæ–°æœåŠ¡å™¨IP
   - TTLï¼š600ï¼ˆ10åˆ†é’Ÿï¼‰
4. ä¿å­˜å¹¶ç­‰å¾…ç”Ÿæ•ˆï¼ˆé€šå¸¸ 5-30 åˆ†é’Ÿï¼‰
5. éªŒè¯ï¼š`nslookup your_domain.com`

## ðŸš¨ å¸¸è§é—®é¢˜

### 1. æ‰¾ä¸åˆ°æ•°æ®åº“åç§°

```bash
# åœ¨æ—§æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹
ssh root@120.79.186.114
mongo
show dbs
# è®°ä¸‹æ•°æ®åº“åç§°
```

### 2. è„šæœ¬æƒé™é—®é¢˜

```bash
# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x migrate.sh
chmod +x setup_new_server.sh
chmod +x verify_migration.sh
```

### 3. MongoDB å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹æ—¥å¿—
sudo tail -50 /var/log/mongodb/mongod.log

# é‡å¯æœåŠ¡
sudo systemctl restart mongod
```

### 4. åº”ç”¨å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -50 /var/log/supervisor/pic-stderr.log

# æ‰‹åŠ¨æµ‹è¯•
cd /var/www/pic
source venv/bin/activate
python app.py
```

## ðŸ“ž éœ€è¦å¸®åŠ©ï¼Ÿ

1. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š
   - `MIGRATION_README.md` - å®Œæ•´è¯´æ˜Ž
   - `docs/migration_guide.md` - è¯¦ç»†æŒ‡å—
   - `docs/migration_quickstart.md` - å¿«é€ŸæŒ‡å—

2. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼š
   - `/var/log/supervisor/pic-stderr.log`
   - `/var/www/pic/logs/pic_app.log`
   - `/var/log/nginx/error.log`

3. è¿è¡ŒéªŒè¯è„šæœ¬ï¼š
   ```bash
   bash verify_migration.sh
   ```

## ðŸ“ é‡è¦æé†’

1. âš ï¸ **ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“åå’ŒåŸŸå**
2. âš ï¸ **è¿ç§»å‰ç¡®ä¿èƒ½ SSH ç™»å½•æ–°æ—§æœåŠ¡å™¨**
3. âš ï¸ **ä¿ç•™æ—§æœåŠ¡å™¨æ•°æ®è‡³å°‘ 1-2 å‘¨**
4. âš ï¸ **åœ¨ä¸šåŠ¡ä½Žå³°æœŸè¿›è¡Œè¿ç§»**
5. âš ï¸ **å®Œå…¨éªŒè¯åŽå†åˆ‡æ¢ DNS**

## ðŸŽ‰ è¿ç§»å®ŒæˆåŽ

1. é…ç½® HTTPS è¯ä¹¦
2. è®¾ç½®è‡ªåŠ¨å¤‡ä»½
3. é…ç½®ç›‘æŽ§å‘Šè­¦
4. ä¼˜åŒ–æ€§èƒ½ï¼ˆç´¢å¼•ã€ç¼“å­˜ç­‰ï¼‰
5. æ¸…ç†æ—§æœåŠ¡å™¨ï¼ˆ1-2å‘¨åŽï¼‰

ç¥è¿ç§»é¡ºåˆ©ï¼ðŸš€
